<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>èƒ½æ¥½æ¼”ç›®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | æ¼”ç›®è©³ç´°æ¤œç´¢</title>
  <meta name="description" content="èƒ½æ¥½ã®æ¼”ç›®åã‚’æ¤œç´¢ã—ã€ã‚ã‚‰ã™ã˜ãƒ»ç™»å ´äººç‰©ãƒ»ä½œæˆè€…ãƒ»æˆç«‹å¹´ä»£ãƒ»æµå„€ãƒ»ç‰¹å¾´ã‚’é–²è¦§ã§ãã‚‹ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@500;700&family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    :root{--bg:#f5efdf;--paper:rgba(255,252,244,.88);--paper2:rgba(255,255,255,.82);--ink:#1a1917;--muted:#646056;--line:rgba(26,25,23,.12);--acc:#a63b18;--acc2:#1f5d65;--shadow:0 16px 36px rgba(41,28,11,.12)}
    *{box-sizing:border-box}html,body{margin:0;padding:0;color:var(--ink);font-family:"Zen Kaku Gothic New",sans-serif;background:radial-gradient(circle at 10% 4%,rgba(166,59,24,.12),transparent 40%),radial-gradient(circle at 86% 10%,rgba(31,93,101,.12),transparent 44%),linear-gradient(180deg,#f7f2e7,#efe2c2);line-height:1.6}
    body::before{content:"";position:fixed;inset:0;pointer-events:none;opacity:.17;background-image:linear-gradient(to right,rgba(0,0,0,.04) 1px,transparent 1px),linear-gradient(to bottom,rgba(0,0,0,.04) 1px,transparent 1px);background-size:22px 22px}
    .wrap{width:min(1220px,calc(100% - 18px));margin:10px auto 26px;position:relative}
    .hero,.panel{border:1px solid var(--line);border-radius:20px;background:var(--paper);box-shadow:var(--shadow);backdrop-filter:blur(6px)}
    .hero{padding:18px 16px;background:linear-gradient(135deg,rgba(255,252,244,.95),rgba(249,237,210,.93))}
    .hero h1{margin:0;font-family:"Shippori Mincho",serif;font-size:clamp(1.5rem,3.7vw,2.25rem)}
    .hero p{margin:.5rem 0 0;color:var(--muted)}
    .badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}.badge{font-size:.8rem;padding:5px 9px;border-radius:999px;border:1px solid rgba(31,93,101,.18);background:rgba(255,255,255,.72);color:#21494f}
    .layout{display:grid;grid-template-columns:370px 1fr;gap:12px;margin-top:12px}
    .panel{padding:12px}
    .side{position:sticky;top:6px;align-self:start}
    h2{margin:0 0 8px;font-size:1rem}
    .label{display:block;font-size:.82rem;color:var(--muted);margin-bottom:5px}
    .field{margin-bottom:10px}
    input[type=search]{width:100%;border:1px solid rgba(26,25,23,.15);border-radius:12px;padding:10px 12px;background:#fff;font-size:.96rem}
    input[type=search]:focus{outline:none;border-color:rgba(166,59,24,.5);box-shadow:0 0 0 4px rgba(166,59,24,.11)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    button{cursor:pointer;border-radius:12px;padding:8px 10px;font-weight:700;border:1px solid transparent;font-size:.84rem}
    .btn-primary{background:linear-gradient(135deg,#b63f1c,#913514);color:#fff;box-shadow:0 8px 16px rgba(145,53,20,.22)}
    .btn-ghost{background:rgba(255,255,255,.86);border-color:rgba(26,25,23,.12);color:var(--ink)}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0 10px}
    .chip{padding:5px 8px;border-radius:999px;border:1px solid rgba(31,93,101,.18);background:rgba(31,93,101,.07);font-size:.78rem;color:#1f4950;cursor:pointer}
    .chip.active{background:rgba(166,59,24,.08);border-color:rgba(166,59,24,.22);color:#7c2a14}
    .meta-note{font-size:.78rem;color:var(--muted);margin-bottom:8px}
    .count{font-size:.83rem;color:var(--muted);margin-bottom:8px}
    .list{display:grid;gap:8px;max-height:68vh;overflow:auto;padding-right:2px}
    .item{display:block;width:100%;text-align:left;border:1px solid rgba(26,25,23,.08);background:var(--paper2);border-radius:14px;padding:10px 10px}
    .item:hover{border-color:rgba(166,59,24,.2)}
    .item.active{border-color:rgba(166,59,24,.38);box-shadow:inset 0 0 0 1px rgba(166,59,24,.16);background:rgba(255,251,245,.95)}
    .item .t{font-family:"Shippori Mincho",serif;font-size:1rem;line-height:1.35}
    .item .k{font-size:.76rem;color:var(--muted);margin-top:2px}
    .item .g{margin-top:6px;font-size:.75rem;display:inline-block;padding:3px 7px;border-radius:999px;background:rgba(31,93,101,.08);color:#1d4a51;border:1px solid rgba(31,93,101,.16)}
    .empty{border:1px dashed rgba(26,25,23,.18);border-radius:14px;background:rgba(255,255,255,.56);padding:12px;color:var(--muted)}
    .detail-head{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;flex-wrap:wrap}
    .detail-title{margin:0;font-family:"Shippori Mincho",serif;font-size:clamp(1.25rem,2.7vw,1.7rem);line-height:1.35}
    .detail-kana{margin:4px 0 0;color:var(--muted);font-size:.9rem}
    .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}.tag{font-size:.77rem;padding:4px 8px;border-radius:999px;border:1px solid rgba(26,25,23,.08);background:rgba(255,255,255,.74)}.tag.genre{background:rgba(31,93,101,.08);border-color:rgba(31,93,101,.17);color:#1d4a51}
    .section{margin-top:12px;padding-top:10px;border-top:1px solid rgba(26,25,23,.07)}
    .section h3{margin:0 0 8px;font-size:.94rem;color:#29373a}
    .facts{display:grid;grid-template-columns:160px 1fr;gap:8px 12px;border:1px solid rgba(26,25,23,.07);border-radius:14px;background:rgba(255,255,255,.62);padding:10px}
    .facts .k{color:#4e473d;font-weight:700}.facts .v{color:#2f2c28}
    .summary-box{border:1px solid rgba(26,25,23,.08);border-radius:14px;background:rgba(255,255,255,.62);padding:10px;white-space:pre-wrap}
    .chars{border:1px solid rgba(26,25,23,.07);border-radius:14px;background:rgba(255,255,255,.62);overflow:hidden}
    .char-row{display:grid;grid-template-columns:120px 190px 1fr;gap:8px;padding:9px 10px;border-top:1px solid rgba(26,25,23,.06)}
    .char-row:first-child{border-top:none}.char-role{font-weight:700;color:#403b34}.char-name{color:#1e2b2f}.char-note{color:#4e4a43}
    .feature-list{margin:0;padding-left:18px}.feature-list li{margin:5px 0}
    .related-head{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .related-status{font-size:.82rem;color:var(--muted)}
    .related-list{display:grid;gap:8px;margin-top:8px}
    .related-item{display:grid;grid-template-columns:76px 1fr;gap:8px;border:1px solid rgba(26,25,23,.07);border-radius:12px;background:rgba(255,255,255,.7);padding:8px}
    .rthumb{width:76px;height:76px;border-radius:10px;border:1px solid rgba(26,25,23,.06);overflow:hidden;background:linear-gradient(180deg,rgba(31,93,101,.07),rgba(166,59,24,.06));display:grid;place-items:center}
    .rthumb img{width:100%;height:100%;object-fit:cover;display:block}.rthumb span{font-size:.72rem;color:var(--muted)}
    .related-item a{color:inherit;text-decoration:none}.related-item .rt{font-size:.88rem;font-weight:700;line-height:1.35}.related-item .rm{font-size:.76rem;color:var(--muted);margin-top:4px}.related-item .rb{display:flex;gap:6px;flex-wrap:wrap;margin-top:5px}
    .mini{font-size:.72rem;padding:3px 7px;border-radius:999px;border:1px solid rgba(26,25,23,.08);background:rgba(255,255,255,.82)}
    .warn{border:1px solid rgba(166,59,24,.18);background:rgba(166,59,24,.05);color:#7a2510;padding:9px 10px;border-radius:12px;font-size:.82rem}
    .footer{margin-top:12px;color:var(--muted);font-size:.8rem}
    .footer code{background:rgba(26,25,23,.05);padding:1px 4px;border-radius:4px}

    /* Mobile UI */
    .fab-btn{display:none;position:fixed;bottom:24px;right:24px;z-index:100;padding:12px 20px;border-radius:999px;background:linear-gradient(135deg,#b63f1c,#913514);color:#fff;font-weight:700;box-shadow:0 4px 16px rgba(166,59,24,.4);border:none;cursor:pointer;font-size:1rem;align-items:center;gap:8px}
    .mobile-header{display:none;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--line)}
    .mobile-header h2{margin:0;font-size:1.2rem}

    @media (max-width:1000px){.layout{grid-template-columns:1fr}.side{position:static}.list{max-height:none}}
    @media (max-width:768px){
      .wrap{width:100%;margin:0}
      .hero{border-radius:0 0 24px 24px;margin-bottom:16px;border-top:none;border-left:none;border-right:none}
      .panel{border:none;box-shadow:none;background:transparent;padding:0 16px 80px} /* Bottom padding for FAB */
      .side{display:none;position:fixed;inset:0;z-index:2000;background:#fcf9f2;margin:0;border-radius:0;overflow-y:auto;padding:16px;height:100dvh}
      .side.open{display:block;animation:fadeIn .25s ease}
      .side > h2#searchTitle{display:none} /* Hide duplicate title on mobile */
      .fab-btn{display:flex}
      .mobile-header{display:flex}
      .facts{display:flex;flex-direction:column;gap:2px}
      .facts .k{margin-top:8px;color:var(--muted);font-size:.85rem}
      .facts .v{padding-left:0}
      .chars{background:transparent;border:none}
      .char-row{display:block;padding:12px 0;border-top:1px dashed rgba(26,25,23,.15);grid-template-columns:none}
      .char-role{display:inline-block;background:rgba(166,59,24,.1);color:#a63b18;padding:2px 8px;border-radius:4px;font-size:.8rem;font-weight:700;margin-right:6px;margin-bottom:4px}
      .char-name{display:inline;font-weight:700;font-size:1rem}
      .char-note{display:block;margin-top:4px;font-size:.9rem;color:var(--muted);line-height:1.5}
      .summary-box{word-break:break-word}
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @media (prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}
  </style>
</head>
<body>
  <meta name="google-site-verification" content="5pNJNJgzysWWyRfVb7qZyiLIWbjocvviLhIe0nkDlD0" />
  <main class="wrap">
    <section class="hero">
      <h1>èƒ½æ¥½æ¼”ç›®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</h1>
      <p>æ¼”ç›®åã‚’æ¤œç´¢ã—ã¦ã€<strong>æ¼”ç›®å / ã‚ã‚‰ã™ã˜ / ç™»å ´äººç‰© / ä½œæˆè€… / ä½œæˆå¹´ï¼ˆæˆç«‹å¹´ä»£ï¼‰ / ä½•æµã‹ / ç‰¹å¾´</strong> ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ç¢ºèªã§ãã¾ã™ã€‚ä¸‹éƒ¨ã«ã¯ Japan Search ã®é–¢é€£è³‡æ–™ã‚‚è¡¨ç¤ºã§ãã¾ã™ã€‚</p>
      <div class="badges">
        <span class="badge">æ¼”ç›®ãƒã‚¹ã‚¿ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«DBï¼‰</span>
        <span class="badge">ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤º</span>
        <span class="badge">Japan Searché–¢é€£è³‡æ–™ã‚’è£œåŠ©è¡¨ç¤º</span>
      </div>
    </section>

    <div class="layout">
      <aside class="panel side" aria-labelledby="searchTitle">
        <div class="mobile-header">
          <h2>æ¼”ç›®æ¤œç´¢</h2>
          <button id="closeSideBtn" class="btn-ghost" type="button">Ã— é–‰ã˜ã‚‹</button>
        </div>
        <h2 id="searchTitle">æ¼”ç›®æ¤œç´¢</h2>
        <div class="field">
          <label class="label" for="searchInput">æ¼”ç›®åãƒ»ã‹ãªãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
          <input id="searchInput" type="search" placeholder="ä¾‹: é“æˆå¯º / ç¾½è¡£ / ç¾©çµŒ / ç‹‚å¥³" autocomplete="off" />
        </div>
        <div class="toolbar">
          <button id="clearBtn" class="btn-ghost" type="button">æ¤œç´¢ã‚¯ãƒªã‚¢</button>
          <button id="firstBtn" class="btn-primary" type="button">å…ˆé ­ã‚’é–‹ã</button>
        </div>
        <div class="chips" id="genreChips" aria-label="ã‚¸ãƒ£ãƒ³ãƒ«çµã‚Šè¾¼ã¿"></div>
        <div class="meta-note" id="metaNote"></div>
        <div class="count" id="listCount"></div>
        <div class="list" id="playList" role="listbox" aria-label="æ¼”ç›®ä¸€è¦§"></div>
      </aside>

      <section class="panel" aria-labelledby="detailTitle">
        <div id="detailArea"></div>
      </section>
    </div>

    <button id="fabBtn" class="fab-btn" type="button">
      <span>ğŸ” æ¼”ç›®ã‚’æ¢ã™</span>
    </button>
  </main>

  <script src="./Noh.data.js?v=20260226-3"></script>
  <script>
    const PLAYS = Array.isArray(window.NOH_PLAYS) ? window.NOH_PLAYS.slice() : [];
    const META = window.NOH_META || {};
    const JPSEARCH_API = "https://jpsearch.go.jp/api/item/search/jps-cross";
    const RELATED_DBS = ["noh_museum", "arc_nishikie", "arc_ban", "arc_books", "enpaku_engekijoen"];

    const ui = {
      search: document.getElementById("searchInput"),
      clearBtn: document.getElementById("clearBtn"),
      firstBtn: document.getElementById("firstBtn"),
      chips: document.getElementById("genreChips"),
      metaNote: document.getElementById("metaNote"),
      count: document.getElementById("listCount"),
      list: document.getElementById("playList"),
      detail: document.getElementById("detailArea"),
      fab: document.getElementById("fabBtn"),
      closeSide: document.getElementById("closeSideBtn"),
      sidePanel: document.querySelector(".side")
    };

    const state = {
      query: "",
      genre: "all",
      selectedId: null,
      filtered: [],
      relatedCache: new Map(),
      relatedLoading: false,
      relatedError: ""
    };

    function esc(v){return String(v ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;");}
    function escAttr(v){return esc(v).replace(/`/g,"&#96;");}
    function norm(v){return String(v ?? "").normalize("NFKC").toLowerCase().replace(/\s+/g, "");}
    function h(text, q){ const t = esc(text); const n = norm(q); if(!n) return t; try{ return t.replace(new RegExp(`(${escapeRegExp(q)})`, "gi"), "<mark>$1</mark>"); }catch{return t;} }
    function escapeRegExp(s){return String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");}
    function join(arr, sep=" / "){ return Array.isArray(arr) ? arr.filter(Boolean).join(sep) : (arr || "-"); }
    function first(arr){ return Array.isArray(arr) && arr.length ? arr[0] : ""; }

    function searchable(play){
      const chars = (play.characters || []).map(c => [c.role, c.name, c.note].filter(Boolean).join(" ")).join(" ");
      return norm([
        play.title, play.kana, play.genre, play.creator, play.created, play.schools, play.summary,
        ...(play.features || []), ...(play.keywords || []), chars
      ].join(" "));
    }

    function genreLabel(play){
      return (play.genre || "").split("ï¼ˆ")[0] || play.genre || "ãã®ä»–";
    }

    function uniqueGenres(){
      const s = new Set(PLAYS.map(genreLabel).filter(Boolean));
      return ["all", ...s];
    }

    function filterPlays(){
      const q = norm(state.query);
      state.filtered = PLAYS.filter(play => {
        if (state.genre !== "all" && genreLabel(play) !== state.genre) return false;
        if (!q) return true;
        return searchable(play).includes(q);
      });
    }

    function ensureSelection(){
      if (!state.filtered.length){ state.selectedId = null; return; }
      if (!state.selectedId || !state.filtered.some(p => p.id === state.selectedId)) {
        state.selectedId = state.filtered[0].id;
      }
    }

    function renderChips(){
      const genres = uniqueGenres();
      ui.chips.innerHTML = genres.map(g => {
        const label = g === "all" ? "ã™ã¹ã¦" : g;
        const active = state.genre === g ? " active" : "";
        return `<button type="button" class="chip${active}" data-genre="${escAttr(g)}">${esc(label)}</button>`;
      }).join("");
      ui.chips.querySelectorAll("[data-genre]").forEach(btn => {
        btn.addEventListener("click", () => {
          state.genre = btn.dataset.genre || "all";
          refresh();
        });
      });
    }

    function renderList(){
      const q = state.query.trim();
      ui.count.textContent = `è¡¨ç¤º: ${state.filtered.length} / å…¨${PLAYS.length}æ¼”ç›®` + (q ? `ï¼ˆæ¤œç´¢: ${q}ï¼‰` : "");

      if (!state.filtered.length){
        ui.list.innerHTML = `<div class="empty">è©²å½“ã™ã‚‹æ¼”ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚åˆ¥ã®è¡¨è¨˜ï¼ˆã‹ãª/æ¼¢å­—ï¼‰ã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§è©¦ã—ã¦ãã ã•ã„ã€‚</div>`;
        return;
      }

      ui.list.innerHTML = state.filtered.map(play => {
        const active = play.id === state.selectedId ? " active" : "";
        return `
          <button type="button" class="item${active}" data-id="${escAttr(play.id)}" role="option" aria-selected="${play.id === state.selectedId}">
            <div class="t">${h(play.title, q)}</div>
            <div class="k">${h(play.kana, q)}</div>
            <span class="g">${esc(play.genre)}</span>
          </button>`;
      }).join("");

      ui.list.querySelectorAll("[data-id]").forEach(btn => {
        btn.addEventListener("click", () => selectPlay(btn.dataset.id));
      });
    }

    function detailHtml(play){
      if (!play){
        return `<div class="empty">æ¼”ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>`;
      }
      const related = state.relatedCache.get(play.id);
      const relatedBlock = renderRelated(play, related);
      return `
        <div class="detail-head">
          <div>
            <h2 id="detailTitle" class="detail-title">${esc(play.title)}</h2>
            <p class="detail-kana">${esc(play.kana)}</p>
            <div class="tags">
              <span class="tag genre">${esc(play.genre)}</span>
              <span class="tag">${esc(play.schools || "äº”æµï¼ˆæµå„€å·®ã‚ã‚Šï¼‰")}</span>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>åŸºæœ¬æƒ…å ±</h3>
          <div class="facts">
            <div class="k">æ¼”ç›®å</div><div class="v">${esc(play.title)}</div>
            <div class="k">èª­ã¿</div><div class="v">${esc(play.kana)}</div>
            <div class="k">ä½œæˆè€…</div><div class="v">${esc(play.creator || "ä¸è©³")}</div>
            <div class="k">ä½œæˆå¹´</div><div class="v">${esc(play.created || "ä¸è©³ï¼ˆæ¨å®šå¹´ä»£ã®ã¿ï¼‰")}</div>
            <div class="k">ä½•æµã‹</div><div class="v">${esc(play.schools || "äº”æµï¼ˆæµå„€å·®ã‚ã‚Šï¼‰")}</div>
            <div class="k">åˆ†é¡</div><div class="v">${esc(play.genre || "-")}</div>
          </div>
        </div>

        <div class="section">
          <h3>ã‚ã‚‰ã™ã˜</h3>
          <div class="summary-box">${esc(play.summary || "ãƒ‡ãƒ¼ã‚¿æœªå…¥åŠ›")}</div>
        </div>

        <div class="section">
          <h3>ç™»å ´äººç‰©</h3>
          <div class="chars">
            ${(play.characters || []).map(ch => `
              <div class="char-row">
                <div class="char-role">${esc(ch.role || "-")}</div>
                <div class="char-name">${esc(ch.name || "-")}</div>
                <div class="char-note">${esc(ch.note || "")}</div>
              </div>`).join("") || `<div class="char-row"><div class="char-role">-</div><div class="char-name">ãƒ‡ãƒ¼ã‚¿æœªå…¥åŠ›</div><div class="char-note"></div></div>`}
          </div>
        </div>

        <div class="section">
          <h3>æ¼”ç›®ã®ç‰¹å¾´</h3>
          <ul class="feature-list">
            ${(play.features || []).map(f => `<li>${esc(f)}</li>`).join("") || `<li>ãƒ‡ãƒ¼ã‚¿æœªå…¥åŠ›</li>`}
          </ul>
          ${(play.keywords && play.keywords.length) ? `<div class="tags" style="margin-top:8px">${play.keywords.map(k => `<span class="tag">${esc(k)}</span>`).join("")}</div>` : ""}
        </div>

        <div class="section">
          <div class="related-head">
            <h3 style="margin:0">é–¢é€£è³‡æ–™ï¼ˆJapan Searchï¼‰</h3>
            <div>
              <button type="button" class="btn-ghost" id="relatedBtn">é–¢é€£è³‡æ–™ã‚’å–å¾—/æ›´æ–°</button>
            </div>
          </div>
          ${relatedBlock}
        </div>

        <div class="section">
          <div class="warn">æ³¨æ„: ã“ã®ãƒšãƒ¼ã‚¸ã®æ¼”ç›®ãƒã‚¹ã‚¿ã¯å­¦ç¿’ãƒ»æ¤œç´¢ç”¨ã«æ•´ç†ã—ãŸè¦ç´„ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚æµå„€å·®ãƒ»å°æ›¸å·®ãƒ»ä¸Šæ¼”ç³»çµ±å·®ãŒã‚ã‚‹ãŸã‚ã€ä¸Šæ¼”ã®ç´°éƒ¨ã¯å„æµå„€è³‡æ–™ãƒ»ç•ªçµ„ãƒ»å°‚é–€è¾å…¸ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>
          <div class="footer">é–¢é€£è³‡æ–™API: <code>${esc(JPSEARCH_API)}</code> / DBãƒ•ã‚£ãƒ«ã‚¿: ${RELATED_DBS.map(db => `<code>${esc(db)}</code>`).join(" ")}</div>
        </div>
      `;
    }

    function renderRelated(play, cache){
      if (!play) return "";
      if (!cache) {
        return `<div class="related-status">ã¾ã å–å¾—ã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€Œ${esc(play.title)}ã€ã§é–¢é€£è³‡æ–™ã‚’æ¤œç´¢ã—ã¾ã™ã€‚</div>`;
      }
      if (cache.loading) {
        return `<div class="related-status">é–¢é€£è³‡æ–™ã‚’å–å¾—ä¸­...</div>`;
      }
      if (cache.error) {
        return `<div class="warn">${esc(cache.error)}</div>`;
      }
      const items = cache.items || [];
      if (!items.length) {
        return `<div class="related-status">é–¢é€£è³‡æ–™ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>`;
      }
      return `
        <div class="related-status">${items.length}ä»¶è¡¨ç¤ºï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${esc(cache.keyword)}ï¼‰ <a href="${escAttr(cache.apiUrl)}" target="_blank" rel="noreferrer">APIçµæœã‚’é–‹ã</a></div>
        <div class="related-list">
          ${items.map(it => {
            const c = it.common || {};
            const thumb = first(c.thumbnailUrl);
            return `
              <div class="related-item">
                <div class="rthumb">${thumb ? `<img src="${escAttr(thumb)}" alt="" loading="lazy" referrerpolicy="no-referrer">` : `<span>ç”»åƒãªã—</span>`}</div>
                <div>
                  <a href="${escAttr(c.linkUrl || '#')}" target="_blank" rel="noreferrer">
                    <div class="rt">${esc(c.title || it.id || "ç„¡é¡Œ")}</div>
                  </a>
                  <div class="rm">${esc(join(c.contributor))}</div>
                  <div class="rb">
                    <span class="mini">DB: ${esc(c.database || "-")}</span>
                    <span class="mini">æä¾›å…ƒ: ${esc(c.provider || c.ownerOrg || "-")}</span>
                    <span class="mini">å…¬é–‹: ${esc(c.contentsAccess || c.access || "-")}</span>
                  </div>
                </div>
              </div>`;
          }).join("")}
        </div>`;
    }

    function renderDetail(){
      const play = state.filtered.find(p => p.id === state.selectedId) || null;
      ui.detail.innerHTML = detailHtml(play);
      const btn = document.getElementById("relatedBtn");
      if (btn && play) btn.addEventListener("click", () => fetchRelated(play));
    }

    async function fetchRelated(play){
      const keyword = `${play.title} èƒ½`;
      const params = new URLSearchParams({ keyword, size: "6" });
      for (const db of RELATED_DBS) params.append("f-db", db);
      const apiUrl = `${JPSEARCH_API}?${params.toString()}`;

      state.relatedCache.set(play.id, { loading: true, items: [], error: "", keyword, apiUrl });
      if (state.selectedId === play.id) renderDetail();

      try {
        const res = await fetch(apiUrl, { headers: { Accept: "application/json" } });
        if (!res.ok) throw new Error(`API ${res.status}`);
        const data = await res.json();
        state.relatedCache.set(play.id, {
          loading: false,
          items: Array.isArray(data.list) ? data.list : [],
          error: "",
          keyword,
          apiUrl
        });
      } catch (e) {
        console.error(e);
        state.relatedCache.set(play.id, {
          loading: false,
          items: [],
          error: "é–¢é€£è³‡æ–™ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚",
          keyword,
          apiUrl
        });
      }
      if (state.selectedId === play.id) renderDetail();
    }

    function selectPlay(id){
      state.selectedId = id;
      renderList();
      renderDetail();
      // ã‚¹ãƒãƒ›ãªã‚‰ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã¦ãƒˆãƒƒãƒ—ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      if (window.innerWidth <= 768 && ui.sidePanel.classList.contains("open")) {
        ui.sidePanel.classList.remove("open");
        document.body.style.overflow = "";
        window.scrollTo({top: 0, behavior: 'smooth'});
      }
    }

    function refresh(){
      filterPlays();
      ensureSelection();
      renderChips();
      renderList();
      renderDetail();
    }

    function init(){
      if (!PLAYS.length) {
        ui.detail.innerHTML = `<div class="warn">æ¼”ç›®ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚<code>Noh.data.js</code> ãŒåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>`;
        ui.list.innerHTML = `<div class="empty">ãƒ‡ãƒ¼ã‚¿æœªèª­è¾¼</div>`;
        return;
      }
      ui.metaNote.textContent = `åéŒ²æ¼”ç›®: ${META.count || PLAYS.length}ä»¶ / ãƒ‡ãƒ¼ã‚¿ç‰ˆ: ${META.version || "-"}`;

      ui.search.addEventListener("input", () => {
        state.query = ui.search.value;
        refresh();
      });

      ui.clearBtn.addEventListener("click", () => {
        ui.search.value = "";
        state.query = "";
        refresh();
        ui.search.focus();
      });

      ui.firstBtn.addEventListener("click", () => {
        if (state.filtered.length) selectPlay(state.filtered[0].id);
      });

      // ã‚¹ãƒãƒ›ç”¨ã‚¤ãƒ™ãƒ³ãƒˆ
      ui.fab.addEventListener("click", () => {
        ui.sidePanel.classList.add("open");
        document.body.style.overflow = "hidden";
      });
      ui.closeSide.addEventListener("click", () => {
        ui.sidePanel.classList.remove("open");
        document.body.style.overflow = "";
      });

      PLAYS.sort((a, b) => a.kana.localeCompare(b.kana, "ja"));
      state.query = "";
      state.genre = "all";
      refresh();
      if (state.selectedId) {
        const firstPlay = state.filtered.find(p => p.id === state.selectedId);
        if (firstPlay) fetchRelated(firstPlay);
      }
    }

    init();
  </script>
</body>
</html>
